# System Output Sink
#
# One stereo pair input, two pairs output
# Pair 1 (AUX0 AUX1) has speaker EQ applied via convoler
# Pair 2 (AUX2 AUX3) is copy of input
#
context.properties = {
    log.level = 0

    default.clock.rate        = 48000
    default.clock.quantum     = 256
}

context.spa-libs = {
    audio.convert.* = audioconvert/libspa-audioconvert
    support.*       = support/libspa-support
}

context.modules = [
    {   name = libpipewire-module-rtkit
        args = {
            #nice.level   = -11
            #rt.prio      = 88
            #rt.time.soft = 200000
            #rt.time.hard = 200000
        }
        flags = [ ifexists nofail ]
    }
    { name = libpipewire-module-protocol-native }
    { name = libpipewire-module-client-node }
    { name = libpipewire-module-adapter }

    { name = libpipewire-module-filter-chain
        args = {
            node.description = "Microphone"
            media.name       = "Microphone"
            filter.graph = {
                nodes = [
                    {
                        type = ladspa
                        name = rnnoise
                        plugin = /usr/lib64/ladspa/librnnoise_ladspa.so
                        label = noise_suppressor_mono
                        control = {
                            "VAD Threshold (%)" 50.0
                        }
                    }
                    {
                        type = ladspa
                        name = comp
                        plugin = /usr/lib64/ladspa/lsp-plugins-ladspa.so
                        label = "http://lsp-plug.in/plugins/ladspa/compressor_mono"
                        control = {
                            "Input gain (G)" = 1.00000000
                            "Output gain (G)" = 1.00000000
                            "Pause graph analysis" = false
                            "Clear graph analysis" = false
                            "Sidechain type" = 0
                            "Sidechain mode" = 1
                            "Sidechain lookahead (ms)" = 0.00000000
                            "Sidechain listen" = false
                            "Sidechain reactivity (ms)" = 10.00000000
                            "Sidechain preamp (G)" = 1.00000000
                            "High-pass filter mode" = 0
                            "High-pass filter frequency (Hz)" = 10.00000000
                            "Low-pass filter mode" = 0
                            "Low-pass filter frequency (Hz)" = 20000.00000000
                            "Compression mode" = 0
                            "Attack threshold (G)" = 0.05020606
                            "Attack time (ms)" = 20.00019073
                            "Release threshold (G)" = 0.00000000
                            "Release time (ms)" = 323.35086060
                            "Ratio" = 100.00000000
                            "Knee (G)" = 0.50329852
                            "Boost threshold (G)" = 0.000251190009
                            "Makeup gain (G)" = 1.00000000
                            "Dry gain (G)" = 0.00000000
                            "Wet gain (G)" = 1.00000000
                            "Sidechain level visibility" = false
                            "Envelope level visibility" = false
                            "Gain reduction visibility" = false
                            "Input level visibility" = false
                            "Output level visibility" = false
                        }
                    }
                    { type  = builtin label = copy name = copy }
                    { type  = builtin label = copy name = L }
                    { type  = builtin label = copy name = R }
                ]
                links = [
                    { output = "rnnoise:Output"  input="comp:Input" }
                    { output = "comp:Output"  input="copy:In" }
                    { output = "copy:Out"  input="L:In" }
                    { output = "copy:Out"  input="R:In" }
                ]
                outputs = [ "L:Out" "R:Out" ]
            }
            capture.props = {
                node.name      = "effect_input.microphone"
                node.target    = "alsa_input.usb-BEHRINGER_UMC1820_BAB9273B-00.pro-input-0"
                node.passive = true
                audio.channels = 1
                audio.position = [ AUX0 ]
            }
            playback.props = {
                media.class = Audio/Source
                node.name      = "effect_output.microphone"
                node.passive   = true
                audio.channels = 2
                audio.position = [ AUX0 AUX1 ]
            }
        }
    }
]
